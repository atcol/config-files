"Use filename rather than full path in airline buffer list
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#fnamemod = ':t'

" Set completeopt to have a better completion experience
" :help completeopt
" menuone: popup even when there's only one match
" noinsert: Do not insert text until a selection is made
" noselect: Do not select, force user to select one from the menu
set completeopt=menuone,noinsert,noselect

" Avoid showing extra messages when using completion
set shortmess+=c

" have a fixed column for the diagnostics to appear in
" this removes the jitter when warnings/errors flow in
set signcolumn=yes

" Set updatetime for CursorHold
" 300ms of no cursor movement to trigger CursorHold
set updatetime=300

" Show diagnostic popup on cursor hover
autocmd CursorHold * lua vim.diagnostic.open_float(nil, { focusable = false })

"
""Don't autoload sessions, but autosave on exit and periodically
" let g:session_autosave='yes'
" let g:session_autosave_periodic=2
" let g:session_autoload='no'

"Use filename rather than full path in airline buffer list
" let g:airline#extensions#tabline#enabled = 1
" let g:airline#extensions#tabline#fnamemod = ':t'
" 
"ignore same files git ignores in CtrlP
" let g:ctrlp_custom_ignore = '\v[\/](node_modules|target|dist|build|_build|doc)|(\.(swp|ico|git|svn))$'
" 
" " Vimfiler don't jump to first child
" let g:vimfiler_expand_jump_to_first_child = 0
" 
set noswapfile
set nocompatible
filetype plugin indent on

autocmd! bufwritepost .vimrc source %
set clipboard=unnamed
set number
syntax on
set wildmode=longest:list
set wildmenu
set history=1000
set expandtab
set tabstop=2
set softtabstop=2
set shiftwidth=2
set autoindent
set smartindent
set smarttab
set textwidth=0
set wrapmargin=0
set colorcolumn=180
set ruler
set confirm
set mouse+=a
set visualbell
set backspace=indent,eol,start
set shiftround
set nostartofline
set t_Co=256
set fileformats=unix,dos
"set pdev=pdf
"set printoptions=paper:A4,syntax:y,wrap:y,duplex:long
set hlsearch
set nofoldenable
"highlight columns past 180
let &colorcolumn=join(range(181,999),",")
highlight ColorColumn ctermbg=235 guibg=#2c2d27

nmap <F8> :TagbarToggle<CR>
let g:tagbar_autofocus = 1
set statusline+=%#warningmsg#
set statusline+=%*

""Search from current directory instead of project root
let g:ctrlp_working_path_mode = 0

:nnoremap <F8> :setl noai nocin nosi inde=<CR>

" Show diagnostic popup on cursor hold
"autocmd CursorHold * lua vim.lsp.diagnostic.open_float()

" Goto previous/next diagnostic warning/error
"nnoremap <silent> g[ <cmd>lua vim.lsp.diagnostic.goto_prev()<CR>
"nnoremap <silent> g] <cmd>lua vim.lsp.diagnostic.goto_next()<CR>

" Find text in files using fzf
nnoremap <silent> <C-h> <esc>:Rg<CR>

"autocmd CursorMoved,InsertLeave,BufEnter,BufWinEnter,TabEnter,BufWritePost *
"autocmd CursorMoved,InsertLeave,TabEnter,BufWritePost *.rs 
"\ lua require'lsp_extensions'.inlay_hints{ prefix = "| ", highlight = "Comment", enabled = {"TypeHint", "ChainingHint", "ParameterHint"} }

au BufRead,BufNewFile *.ml,*.mli,*.mly,*.mll compiler ocaml

" Quick-fix
"nnoremap <silent> ga    <cmd>lua vim.lsp.buf.code_action()<CR>

colorscheme koehler

nnoremap <C-K> :bnext<CR>
nnoremap <C-J> :bprev<CR>

command! Bd bp | sp | bn | bd
nnoremap <C-C> :Bd<CR>

lua << EOF

local bufnr = vim.api.nvim_get_current_buf()

-- Code actions (supports rust-analyzer's grouping)
vim.keymap.set(
  "n", 
  "<F5>", 
  function()
    vim.cmd.RustLsp('codeAction')
  end,
  { silent = true, buffer = bufnr, desc = "Code Action" }
)

-- Hover actions (override K)
vim.keymap.set(
  "n", 
  "<leader>ca",
  function()
    vim.cmd.RustLsp({'hover', 'actions'})
  end,
  { silent = true, buffer = bufnr, desc = "Hover Actions" }
)

-- Run/Debug
vim.keymap.set(
  "n",
  "<leader>rr",
  function()
    vim.cmd.RustLsp('runnables')
  end,
  { silent = true, buffer = bufnr, desc = "Runnables" }
)

-- Testing
vim.keymap.set(
  "n",
  "<leader>rt",
  function()
    vim.cmd.RustLsp('testables')
  end,
  { silent = true, buffer = bufnr, desc = "Testables" }
)
EOF
